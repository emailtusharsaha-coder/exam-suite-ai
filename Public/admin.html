<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #333; margin: 0; }
        * { box-sizing: border-box; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); overflow: hidden; }

        .admin-header { background: #0056b3; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .admin-header h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .back-link { color: rgba(255,255,255,0.8); text-decoration: none; font-weight: bold; }

        .toolbar { padding: 20px 30px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; gap: 15px; }

        #prompt-section { display: none; background: #fff8f0; padding: 30px; border-bottom: 2px solid #ff6b35; }
        .editor-container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        
        select.prompt-select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; }
        textarea.code-editor { width: 100%; height: 350px; padding: 15px; font-family: 'Consolas', 'Monaco', monospace; border: 2px solid #0056b3; border-radius: 8px; background: #fdfdfd; resize: vertical; }

        .table-wrapper { padding: 30px; }
        table { width: 100%; border-collapse: collapse; border-radius: 8px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #004494; color: white; text-transform: uppercase; font-size: 0.85rem; }
        tr:hover { background: #f9f9f9; }

        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; }
        .btn-blue { background: #0056b3; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-orange { background: #ff6b35; }
        .role-badge { background: #e9ecef; color: #495057; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .role-admin { background: #ff6b35; color: white; }

        /* --- MOBILE PATCH --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { width: 100%; }
            .admin-header { flex-direction: column; gap: 10px; text-align: center; }
            .toolbar { flex-direction: column; padding: 15px; }
            .btn { width: 100%; }
            
            /* Scrollable Table */
            .table-wrapper { overflow-x: auto; padding: 15px; }
            table { min-width: 600px; } 

            /* Stack Editor */
            .editor-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-header">
            <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
            <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Home</a>
        </div>
        <div class="toolbar">
            <button class="btn btn-orange" onclick="togglePrompts()"><i class="fas fa-edit"></i> Open Prompt Manager</button>
            <button class="btn btn-blue" onclick="loadUsers()"><i class="fas fa-sync"></i> Refresh Users</button>
        </div>

        <div id="prompt-section">
            <h2 style="margin-top: 0; color: #ff6b35;"><i class="fas fa-terminal"></i> Edit AI Prompts</h2>
            <div class="editor-container">
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 8px;">Select Prompt:</label>
                    <select id="prompt-select" class="prompt-select" onchange="loadSelectedPrompt()" size="10"><option value="">-- Load Prompts First --</option></select>
                    <button class="btn btn-green" onclick="savePrompt()" style="width: 100%; margin-top: 15px;">Save Changes</button>
                </div>
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 8px;">Prompt Template:</label>
                    <textarea id="prompt-editor" class="code-editor" placeholder="Select a prompt to edit..."></textarea>
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <h3>Registered Users</h3>
            <table id="user-table">
                <thead>
                    <tr><th>Name</th><th>Email</th><th>Role</th><th>Tokens</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users', { headers: { 'auth-token': token } });
                if (res.status === 403) { alert("Access Denied"); window.location.href = 'index.html'; return; }
                const users = await res.json();
                const tbody = document.querySelector('#user-table tbody');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const roleClass = user.role === 'admin' ? 'role-admin' : '';
                    const row = `<tr><td><strong>${user.username}</strong></td><td>${user.email}</td><td><span class="role-badge ${roleClass}">${user.role}</span></td><td>${user.stats ? user.stats.tokensUsed : 0}</td><td><button class="btn btn-green" onclick="addCredits('${user._id}')">+1k</button> <button class="btn btn-red" onclick="deleteUser('${user._id}')"><i class="fas fa-trash"></i></button></td></tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) { console.error(err); }
        }
        async function addCredits(userId) { if(!confirm("Give 1000 credits?")) return; await fetch('/api/admin/add-credits', { method: 'POST', headers: { 'Content-Type': 'application/json', 'auth-token': token }, body: JSON.stringify({ userId, amount: 1000 }) }); loadUsers(); }
        async function deleteUser(userId) { if(!confirm("Delete user?")) return; await fetch(`/api/admin/user/${userId}`, { method: 'DELETE', headers: { 'auth-token': token } }); loadUsers(); }
        
        async function togglePrompts() { const s = document.getElementById('prompt-section'); s.style.display = s.style.display === 'none' ? 'block' : 'none'; if(s.style.display==='block') loadPromptList(); }
        async function loadPromptList() { const res = await fetch('/api/admin/prompts', { headers: { 'auth-token': token } }); const prompts = await res.json(); window.allPrompts = prompts; const sel = document.getElementById('prompt-select'); sel.innerHTML = ''; prompts.forEach(p => sel.innerHTML += `<option value="${p._id}">${p.name}</option>`); if(prompts.length) { sel.value = prompts[0]._id; loadSelectedPrompt(); } }
        function loadSelectedPrompt() { const id = document.getElementById('prompt-select').value; const p = window.allPrompts.find(x => x._id === id); if(p) document.getElementById('prompt-editor').value = p.template; }
        async function savePrompt() { const id = document.getElementById('prompt-select').value; const t = document.getElementById('prompt-editor').value; if(!id) return; await fetch(`/api/admin/prompt/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'auth-token': token }, body: JSON.stringify({ template: t }) }); alert("Updated!"); }
        
        loadUsers();
    </script>
</body>
</html>